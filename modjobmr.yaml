params:
  # Unikraft-specific
  - name: LWIP_NUM_TCPCON
    type: int
    only: [8] #, 16, 32, 64]

  - name: LWIP_NUM_TCPLISTENERS
    type: int
    only: [8] #, 16, 32, 64]
  
  - name: LWIP_UKNETDEV_POLLONLY
    type: string
    only: ["y"] #, "n"]
  
  - name: LWIP_POOLS
    type: string
    only: ["y"] #, "n"]

  # -----------------------------------
  # Added by me:
  # -----------------------------------

  # Allocator options:
  # -----------------------------------

  # Chose allocator:
  - name: ALLOCATOR
    type: string
    only: ["bbudy"] #, "regalloc", "tinyalloc", "tlsf", "none"] # tlsf depends on LIBTLSF_INCLUDED

  # Mimalloc options: (Mimalloc does not work yet!)
  # - name: LIBMIMALLOC_MIMALLOC_DEBUG
  #   type: int
  #   only: [0] #, 1, 2]

  # - name: LIBMIMALLOC_ASSERT
  #   type: string
  #   only: ["y"] #, "n"]

  # TLSF specific options:
  - name: LIBTLSF_TLSF_LOG2_SLI
    type: int
    only: [4] #, 5, 6, 7] # do not try more then 7

  # LWIP options:
  #------------------------------------
  - name: LWIP_TCP_QUEUE_OOSEQ
    type: int
    only: [0] #, 1, 2, 3, 4]

  - name: LWIP_SND_BUF
    type: int
    only: [1] #, 2, 4]    # are bigger numbers then 2 even worth it?! Recommended are 0xFFFF as max.
  # -----------------------------------
  # -----------------------------------

  #! - name: LWIP_POOLS_TRY_BIGGER_POOL
  #!   type: string
  #!   only: ["y", "n"]

  #! - name: MEMP_USE_CUSTOM_POOLS
  #!   type: string
  #!   only: ["y", "n"]

  # Nginx-specific
  - name: ACCESS_LOG
    type: string
    only: ["y"] #, "n"]

  - name: KEEPALIVE_TIMEOUT
    type: int
    only: [0] #, 60]

  - name: OPEN_FILE_CACHE
    type: string
    only: ["caching"] #, "nocaching"]

  # Client-specific
  - name: WORKER_CONNECTIONS
    type: int
    only: [63]

  - name: PAYLOAD_SIZE
    type: int
    only: [612] # bytes
  
  - name: NUM_PARALLEL_CONNS
    type: int
    only: [30]

inputs:
  - source: /etc/resolv.conf
    destination: /etc/resolv.conf
  - source: /etc/environment
    destination: /etc/environment
  - source: ./test.sh
    destination: /test.sh
  - source: ./nginx-caching.conf
    destination: /nginx-caching.conf
  - source: ./nginx-nocaching.conf
    destination: /nginx-nocaching.conf

outputs:
  - path: /usr/src/unikraft/apps/nginx/build/nginx_kvm-x86_64
  - path: /usr/src/unikraft/apps/nginx/initramfs.cpio
  - path: /results.txt

runs:
  - name: build
    image: alexpawe/ukbench-unikraft
    cores: 30
    devices:
      - /dev/urandom
    cmd:
      |
      set -ex
      export UK_WORKDIR=/usr/src/unikraft
      export UK_CACHEDIR=/usr/src/unikraft/.kraftcache
      export KRAFTRC=/usr/src/unikraft/.kraftrc
      export LC_ALL=C.UTF-8
      export LANG=C.UTF-8
      for env in $(cat /etc/environment); do \
        export $(echo $env | sed -e 's/"//g'); \
      done

      cd /usr/src/unikraft/apps/nginx
      SET_ALLOCATOR=""
      if [[ $ALLOCATOR="bbuddy" ]]; then
        SET_ALLOCATOR="--set LIBUKBOOT_INITBBUDY=y"
      elif [[ $ALLOCATOR="regalloc" ]]; then
        SET_ALLOCATOR="--set LIBUKBOOT_INITREGION=y"
      elif [[ $ALLOCATOR="tinyalloc" ]]; then
        SET_ALLOCATOR="--set LIBUKBOOT_INITTINYALLOC=y"
      elif [[ $ALLOCATOR="tlsf" ]]; then
        SET_ALLOCATOR="--set LIBUKBOOT_INITTLSF=y"
      elif [[ $ALLOCATOR="none" ]]; then
        SET_ALLOCATOR="--set LIBUKBOOT_NOALLOC=y"
      fi
      
      kraft -v configure \
        --arch x86_64 \
        --plat kvm \
        --set LWIP_NUM_TCPCON=$LWIP_NUM_TCPCON \
        --set LWIP_NUM_TCPLISTENERS=$LWIP_NUM_TCPLISTENERS \
        --set LWIP_UKNETDEV_POLLONLY=$LWIP_UKNETDEV_POLLONLY \
        --set LWIP_POOLS=$LWIP_POOLS \
        $SET_ALLCOCATOR \
        --set LWIP_TCP_QUEUE_OOSEQ=$LWIP_TCP_QUEUE_OOSEQ \
        --set LWIP_SND_BUF=$LWIP_SND_BUF \
        --set LIBTLSF_TLSF_LOG2_SLI=$LIBTLSF_TLSF_LOG2_SLI \
        --set LIBDEVFS_DEV_STDOUT=$ACCESS_LOG \
        --yes LIBVFSCORE_ROOTFS_RAMFS \
        --yes LIBINITRAMFS \
        --yes LIBCPIO \
        --no  LIB9PFS \
        --no  LIBUK9P

      kraft build
      cat /nginx-$OPEN_FILE_CACHE.conf | sed "s/\$WORKER_CONNECTIONS/${WORKER_CONNECTIONS}/g" > ./fs0/nginx/conf/nginx.conf
      if [[ $ACCESS_LOG == "y" ]]; then \
        export ACCESS_LOG="\/dev\/stdout"; \
      else \
        export ACCESS_LOG="off"; \
      fi
      sed -i "s/\$ACCESS_LOG/${ACCESS_LOG}/g" ./fs0/nginx/conf/nginx.conf
      sed -i "s/\$KEEPALIVE_TIMEOUT/${KEEPALIVE_TIMEOUT}/g" ./fs0/nginx/conf/nginx.conf

      cat ./fs0/nginx/conf/nginx.conf

      # Generate cpio image
      cd fs0/
      tr -dc A-Za-z0-9 </dev/urandom | head -c ${PAYLOAD_SIZE} > ./nginx/html/payload.txt
      find -depth -print | tac | bsdcpio -o --format newc > ../initramfs.cpio

  - name: run
    image: alexpawe/ukbench-unikraft
    cores: 30
    devices:
      - /dev/kvm
      - /dev/net/tun
    capabilities:
      - CAP_NET_ADMIN
    cmd: /test.sh

